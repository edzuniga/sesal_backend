# ๐ Diagrama de Flujo de Configuraciรณn

## ๐ Flujo de Carga de Configuraciรณn de Base de Datos

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    INICIO DE APLICACIรN                      โ
โ                     (src/server.ts)                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         prepararConfiguracion()                              โ
โ   configuracionBDServicio.cargarConfiguracionPersistida()   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
                โโโโโโโโโโโโโโโโโโ
                โ NODE_ENV === ? โ
                โโโโโโโโโโฌโโโโโโโโ
                         โ
         โโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโ
         โ                               โ
         โผ                               โผ
โโโโโโโโโโโโโโโโโโโ            โโโโโโโโโโโโโโโโโโโ
โ  'production'   โ            โ  'development'  โ
โโโโโโโโโโฌโโโโโโโโโ            โโโโโโโโโโฌโโโโโโโโโ
         โ                               โ
         โผ                               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ MODO PRODUCCIรN          โ  โ ๐ MODO DESARROLLO       โ
โ                             โ  โ                          โ
โ 1. IGNORA archivo           โ  โ 1. Lee archivo           โ
โ    .bi-sesal/               โ  โ    .bi-sesal/            โ
โ                             โ  โ    database-config.json  โ
โ 2. USA SOLO variables       โ  โ                          โ
โ    de ecosystem.config.js:  โ  โ 2. Si existe:            โ
โ    - MYSQL_HOST             โ  โ    โ Usa config archivo  โ
โ    - MYSQL_PORT             โ  โ                          โ
โ    - MYSQL_USER             โ  โ 3. Si NO existe:         โ
โ    - MYSQL_PASSWORD         โ  โ    โ Usa .env            โ
โ    - MYSQL_DATABASE         โ  โ                          โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโ  โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
               โ                            โ
               โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
                          โ
                          โผ
         โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ   crearNuevoPool()             โ
         โ   (src/base_datos/pool.ts)     โ
         โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
                          โ
                          โผ
         โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ   mysql.createPool({           โ
         โ     host: config.host,         โ
         โ     port: config.port,         โ
         โ     user: config.username,     โ
         โ     password: config.password, โ
         โ     database: config.database  โ
         โ   })                           โ
         โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
                          โ
                          โผ
         โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ   โ POOL INICIALIZADO         โ
         โ   Aplicaciรณn lista             โ
         โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ฏ Prioridad de Configuraciรณn

### En Producciรณn (NODE_ENV=production)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PRIORIDAD 1 (รNICA):                   โ
โ  ecosystem.config.js                    โ
โ  โ Siempre se usa                      โ
โ                                         โ
โ  IGNORADO:                              โ
โ  .bi-sesal/database-config.json         โ
โ  โ Nunca se lee                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### En Desarrollo (NODE_ENV=development)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PRIORIDAD 1:                           โ
โ  .bi-sesal/database-config.json         โ
โ  โ Si existe, se usa                   โ
โ                                         โ
โ  PRIORIDAD 2 (fallback):                โ
โ  .env                                   โ
โ  โ Si no existe archivo, se usa .env   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ Flujo de Solicitud HTTP

```
โโโโโโโโโโโโโโโโ
โ   Cliente    โ
โ  (Frontend)  โ
โโโโโโโโฌโโโโโโโโ
       โ HTTP Request
       โ Origin: http://172.16.36.59
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Middleware: CORS                    โ
โ  (src/aplicacion.ts)                 โ
โ                                      โ
โ  1. Lee CORS_ORIGINS del env         โ
โ  2. Valida origin                    โ
โ  3. Si vรกlido: continรบa              โ
โ     Si invรกlido: Error 403           โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
               โ โ CORS OK
               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Middleware: Rate Limit              โ
โ  (300 req/min por IP)                โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
               โ โ Rate OK
               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Rutas: /api/*                       โ
โ  (src/rutas/)                        โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
               โ
               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Controlador                         โ
โ  (src/controladores/)                โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
               โ
               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Servicio                            โ
โ  (src/servicios/)                    โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
               โ Query SQL
               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Pool de Conexiones                  โ
โ  (src/base_datos/pool.ts)            โ
โ                                      โ
โ  Configuraciรณn segรบn NODE_ENV        โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
               โ
               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  MySQL Server                        โ
โ  172.16.34.68:3306                   โ
โ  Database: sesal_historico           โ
โ  User: root                          โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
               โ Resultado
               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Respuesta JSON al Cliente           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐๏ธ Arquitectura de Servidores

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     ARQUITECTURA ACTUAL                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโโ
โ   Servidor 1     โ         โ   Servidor 2     โ         โ   Servidor 3     โ
โ   FRONTEND       โ         โ   BACKEND        โ         โ   BASE DE DATOS  โ
โ                  โ         โ                  โ         โ                  โ
โ  IP: 172.16.36.59โโโโโโโโโโถโ  IP: 172.16.36.58โโโโโโโโโโถโ  IP: 172.16.34.68โ
โ                  โ  HTTP   โ                  โ  MySQL  โ                  โ
โ  Vue.js          โ  Req    โ  Node.js/Express โ  Query  โ  MySQL 8.0       โ
โ  Puerto: 80/443  โ         โ  Puerto: 4000    โ         โ  Puerto: 3306    โ
โ                  โ         โ  PM2 (cluster)   โ         โ                  โ
โ                  โ         โ  2 instancias    โ         โ  sesal_historico โ
โโโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโโ
         โ                            โ                            โ
         โ                            โ                            โ
         โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              Red Interna
                           172.16.x.x/24
```

## ๐ง Variables de Entorno por Servidor

### Servidor Backend (172.16.36.58)

```env
# ecosystem.config.js
NODE_ENV=production
PORT=4000

# Conexiรณn a BD (Servidor 3)
MYSQL_HOST=172.16.34.68
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=Animalit0..9
MYSQL_DATABASE=sesal_historico

# CORS (Servidor 1)
CORS_ORIGINS=http://172.16.36.59

# Pool de conexiones
MYSQL_CONNECTION_LIMIT=50
MYSQL_QUEUE_LIMIT=200
MYSQL_CONNECT_TIMEOUT=20000
MYSQL_QUERY_TIMEOUT=300000
```

## ๐ Puntos de Verificaciรณn

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              CHECKLIST DE VERIFICACIรN                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1. โ Variables de Entorno
   โโ pm2 env 0 | grep MYSQL
      Debe mostrar: MYSQL_USER=root

2. โ Archivo Persistido
   โโ ls -la .bi-sesal/
      Debe mostrar: No such file or directory

3. โ Conexiรณn a BD
   โโ curl http://localhost:4000/api/health/db
      Debe responder: {"connected":true}

4. โ Logs de PM2
   โโ pm2 logs bisesal-backend | grep "DB CONFIG"
      Debe mostrar: user: root

5. โ CORS
   โโ Desde frontend, hacer request
      No debe haber errores de CORS

6. โ Modo Producciรณn
   โโ pm2 logs bisesal-backend | grep "Modo producciรณn"
      Debe mostrar: "๐ Modo producciรณn: usando solo variables de entorno"
```

## ๐จ Flujo de Error Comรบn (RESUELTO)

### Antes (con error):

```
PM2 start
    โ
    โผ
Lee .bi-sesal/database-config.json
    โ
    โผ
Usuario: wsuario1 โ
Host: 172.16.36.58 โ
    โ
    โผ
Intenta conectar a MySQL
    โ
    โผ
โ Access denied for user 'wsuario1'@'172.16.36.58'
```

### Ahora (funcionando):

```
PM2 start
    โ
    โผ
NODE_ENV=production detectado
    โ
    โผ
IGNORA .bi-sesal/database-config.json
    โ
    โผ
Lee ecosystem.config.js
    โ
    โผ
Usuario: root โ
Host: 172.16.34.68 โ
Puerto: 3306 โ
    โ
    โผ
Conecta a MySQL
    โ
    โผ
โ Conexiรณn exitosa
```

## ๐ Notas Tรฉcnicas

- **Pool de Conexiones**: 50 conexiones simultรกneas en producciรณn
- **Timeout de Queries**: 5 minutos (300,000 ms)
- **Rate Limiting**: 300 requests por minuto por IP
- **Charset**: utf8mb4 (soporte completo de Unicode)
- **Keep-Alive**: Habilitado con delay de 10 segundos
- **Cluster Mode**: PM2 en modo cluster (mรบltiples instancias)

---

**รltima actualizaciรณn**: Diciembre 2025
